generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  razonSocial                String                     @map("razon_social") @db.VarChar
  rut                        String                     @db.VarChar
  nombreComercial            String?                    @map("nombre_comercial") @db.VarChar
  giroSii                    String?                    @map("giro_sii") @db.VarChar
  tamanoEmpresa              String?                    @map("tamano_empresa") @db.VarChar
  direccion                  String?                    @db.VarChar
  phone                      String?                    @db.VarChar
  slugPublico                String?                    @unique @map("slug_publico") @db.VarChar
  publicProfileOptIn         Boolean                    @default(false) @map("public_profile_opt_in")
  preferredCalculationMethod CalculationType            @default(MINIMAL_INPUT) @map("preferred_calculation_method")
  status                     CompanyStatus
  createdAt                  DateTime                   @default(now()) @map("created_at")
  updatedAt                  DateTime                   @updatedAt @map("updated_at")
  id                         String                     @id @default(uuid()) @db.Uuid
  apiKeys                    ApiKey[]
  apiUsageLogs               ApiUsageLog[]
  certificateRequests        CertificateRequest[]
  certificates               Certificate[]
  companyBadges              CompanyBadge[]
  companyCalculationMetrics  CompanyCalculationMetric[]
  documents                  CompanyDocument[]
  domains                    CompanyDomain[]
  pricingOverrides           CompanyPricingOverride[]
  settings                   CompanySettings?
  companyUsers               CompanyUser[]
  verificationEvents         CompanyVerificationEvent[]
  compensationOrders         CompensationOrder[]
  emissionSummaries          EmissionSummary[]
  flightRecords              FlightRecord[]
  payments                   Payment[]
  quickCalculations          QuickCalculation[]
  rankingSnapshots           RankingSnapshot[]
  routeSummaries             RouteSummary[]
  shareEvents                ShareEvent[]
  uploadBatches              UploadBatch[]
  webhooks                   Webhook[]
  widgets                    Widget[]

  @@map("companies")
}

model CompanyDocument {
  docType    String     @map("doc_type") @db.VarChar
  status     String     @db.VarChar
  uploadedAt DateTime   @map("uploaded_at")
  id         String     @id @default(uuid()) @db.Uuid
  companyId  String     @map("company_id") @db.Uuid
  fileId     String     @map("file_id") @db.Uuid
  company    Company    @relation(fields: [companyId], references: [id])
  file       FileUpload @relation(fields: [fileId], references: [id])

  @@map("company_documents")
}

model CompanyDomain {
  domain     String    @db.VarChar
  verified   Boolean   @default(false)
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  id         String    @id @default(uuid()) @db.Uuid
  companyId  String    @map("company_id") @db.Uuid
  company    Company   @relation(fields: [companyId], references: [id])

  @@map("company_domains")
}

model CompanySettings {
  publicTagline     String?  @map("public_tagline") @db.VarChar
  publicBannerUrl   String?  @map("public_banner_url") @db.VarChar
  notificationsJson String?  @map("notifications_json")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  id                String   @id @default(uuid()) @db.Uuid
  companyId         String   @unique @map("company_id") @db.Uuid
  company           Company  @relation(fields: [companyId], references: [id])

  @@map("company_settings")
}

model CompanyVerificationEvent {
  fromStatus    CompanyStatus @map("from_status")
  toStatus      CompanyStatus @map("to_status")
  note          String?
  createdAt     DateTime      @default(now()) @map("created_at")
  id            String        @id @default(uuid()) @db.Uuid
  companyId     String        @map("company_id") @db.Uuid
  notedByUserId String        @map("noted_by_user_id") @db.Uuid
  company       Company       @relation(fields: [companyId], references: [id])
  user          User          @relation(fields: [notedByUserId], references: [id])

  @@map("company_verification_events")
}

model User {
  email                  String                     @unique @db.VarChar
  name                   String                     @db.VarChar
  passwordHash           String                     @map("password_hash") @db.VarChar
  isActive               Boolean                    @default(true) @map("is_active")
  lastLoginAt            DateTime?                  @map("last_login_at")
  createdAt              DateTime                   @default(now()) @map("created_at")
  updatedAt              DateTime                   @updatedAt @map("updated_at")
  id                     String                     @id @default(uuid()) @db.Uuid
  globalRoles            UserGlobalRoles[]
  auditLogs              AuditLog[]
  companyUsers           CompanyUser[]
  verificationEvents     CompanyVerificationEvent[]
  globalMarginConfigs    GlobalMarginConfig[]
  loginEvents            LoginEvent[]
  projectPricingAudits   ProjectPricingAudit[]      @relation("ChangedByUser")
  projectPricingVersions ProjectPricingVersion[]

  @@map("users")
}

model CompanyUser {
  isAdmin   Boolean           @default(false) @map("is_admin")
  status    String            @default("active") @db.VarChar
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")
  id        String            @id @default(uuid()) @db.Uuid
  companyId String            @map("company_id") @db.Uuid
  userId    String            @map("user_id") @db.Uuid
  roles     CompanyUserRole[]
  company   Company           @relation(fields: [companyId], references: [id])
  user      User              @relation(fields: [userId], references: [id])

  @@unique([companyId, userId])
  @@map("company_users")
}

model Role {
  code             String            @unique @db.VarChar
  name             String            @db.VarChar
  description      String?
  createdAt        DateTime          @default(now()) @map("created_at")
  id               String            @id @default(uuid()) @db.Uuid
  globalUsers      UserGlobalRoles[]
  companyUserRoles CompanyUserRole[]
  permissions      RolePermission[]

  @@map("roles")
}

model UserGlobalRoles {
  userId String @db.Uuid
  roleId String @db.Uuid
  role   Role   @relation(fields: [roleId], references: [id])
  user   User   @relation(fields: [userId], references: [id])

  @@id([userId, roleId])
}

model Permission {
  code        String           @unique @db.VarChar
  name        String           @db.VarChar
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  id          String           @id @default(uuid()) @db.Uuid
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  createdAt    DateTime   @default(now()) @map("created_at")
  id           String     @id @default(uuid()) @db.Uuid
  roleId       String     @map("role_id") @db.Uuid
  permissionId String     @map("permission_id") @db.Uuid
  permission   Permission @relation(fields: [permissionId], references: [id])
  role         Role       @relation(fields: [roleId], references: [id])

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

model CompanyUserRole {
  createdAt     DateTime    @default(now()) @map("created_at")
  id            String      @id @default(uuid()) @db.Uuid
  companyUserId String      @map("company_user_id") @db.Uuid
  roleId        String      @map("role_id") @db.Uuid
  companyUser   CompanyUser @relation(fields: [companyUserId], references: [id])
  role          Role        @relation(fields: [roleId], references: [id])

  @@unique([companyUserId, roleId])
  @@map("company_user_roles")
}

model UploadBatch {
  filename       String          @db.VarChar
  sizeBytes      Int             @map("size_bytes")
  rowsCount      Int?            @map("rows_count")
  status         BatchStatus
  errorMessage   String?         @map("error_message")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  id             String          @id @default(uuid()) @db.Uuid
  companyId      String          @map("company_id") @db.Uuid
  batchSummary   BatchSummary?
  flightRecords  FlightRecord[]
  manifestFile   ManifestFile?
  processingRuns ProcessingRun[]
  company        Company         @relation(fields: [companyId], references: [id])

  @@map("upload_batches")
}

model ManifestFile {
  storageUrl String      @map("storage_url") @db.VarChar
  checksum   String      @db.VarChar
  createdAt  DateTime    @default(now()) @map("created_at")
  id         String      @id @default(uuid()) @db.Uuid
  batchId    String      @unique @map("batch_id") @db.Uuid
  batch      UploadBatch @relation(fields: [batchId], references: [id])

  @@map("manifest_files")
}

model FlightRecord {
  calculationType      CalculationType         @map("calculation_type")
  flightNumber         String?                 @map("flight_number") @db.VarChar
  flightDate           DateTime                @map("flight_date") @db.Date
  totalPassengers      Int                     @map("total_passengers")
  distanceKm           Decimal                 @map("distance_km") @db.Decimal(10, 2)
  computedEmissions    Decimal                 @map("computed_emissions") @db.Decimal(10, 2)
  confidenceScore      Decimal                 @map("confidence_score") @db.Decimal(3, 2)
  emissionSource       EmissionSource          @map("emission_source")
  validationStatus     ValidationStatus        @map("validation_status")
  anomalyFlags         String?                 @map("anomaly_flags")
  rawRowRef            String?                 @map("raw_row_ref")
  createdAt            DateTime                @default(now()) @map("created_at")
  id                   String                  @id @default(uuid()) @db.Uuid
  companyId            String                  @map("company_id") @db.Uuid
  batchId              String?                 @map("batch_id") @db.Uuid
  originAirportId      String                  @map("origin_airport_id") @db.Uuid
  destinationAirportId String                  @map("destination_airport_id") @db.Uuid
  aircraftModelId      String                  @map("aircraft_model_id") @db.Uuid
  classBreakdown       Json?                   @map("class_breakdown")
  apiResponseData      Json?                   @map("api_response_data")
  factorsVersionId     String                  @map("factors_version_id") @db.Uuid
  calculationMetadata  Json?                   @map("calculation_metadata")
  aircraftModel        AircraftModel           @relation(fields: [aircraftModelId], references: [id])
  batch                UploadBatch?            @relation(fields: [batchId], references: [id])
  company              Company                 @relation(fields: [companyId], references: [id])
  destinationAirport   Airport                 @relation("DestinationAirport", fields: [destinationAirportId], references: [id])
  emissionFactor       EmissionFactor          @relation(fields: [factorsVersionId], references: [id])
  originAirport        Airport                 @relation("OriginAirport", fields: [originAirportId], references: [id])
  validationErrors     RecordValidationError[]

  @@map("flight_records")
}

model RecordValidationError {
  code           String        @db.VarChar
  message        String
  severity       SeverityLevel
  createdAt      DateTime      @default(now()) @map("created_at")
  id             String        @id @default(uuid()) @db.Uuid
  flightRecordId String        @map("flight_record_id") @db.Uuid
  flightRecord   FlightRecord  @relation(fields: [flightRecordId], references: [id])

  @@map("record_validation_errors")
}

model ProcessingRun {
  runType      String      @map("run_type") @db.VarChar
  status       JobStatus
  startedAt    DateTime    @map("started_at")
  finishedAt   DateTime?   @map("finished_at")
  metricsJson  String?     @map("metrics_json")
  errorMessage String?     @map("error_message")
  id           String      @id @default(uuid()) @db.Uuid
  batchId      String      @map("batch_id") @db.Uuid
  batch        UploadBatch @relation(fields: [batchId], references: [id])

  @@map("processing_runs")
}

model TransportType {
  id              String           @id @default(uuid()) @db.Uuid
  code            String           @unique @db.VarChar
  name            String           @db.VarChar
  description     String?
  active          Boolean          @default(true)
  createdAt       DateTime         @default(now()) @map("created_at")
  emissionFactors EmissionFactor[]
  serviceClasses  ServiceClass[]

  @@map("transport_types")
}

model Airport {
  code               String               @unique @db.VarChar
  name               String               @db.VarChar
  city               String               @db.VarChar
  country            String               @db.VarChar
  lat                Decimal              @db.Decimal(10, 6)
  lon                Decimal              @db.Decimal(10, 6)
  createdAt          DateTime             @default(now()) @map("created_at")
  id                 String               @id @default(uuid()) @db.Uuid
  destinationFlights FlightRecord[]       @relation("DestinationAirport")
  originFlights      FlightRecord[]       @relation("OriginAirport")
  destinationCaches  RouteDistanceCache[] @relation("DestinationCache")
  originCaches       RouteDistanceCache[] @relation("OriginCache")
  destinationRoutes  RouteSummary[]       @relation("DestinationRoutes")
  originRoutes       RouteSummary[]       @relation("OriginRoutes")

  @@map("airports")
}

model AircraftModel {
  code                 String                     @unique @db.VarChar
  name                 String                     @db.VarChar
  category             String                     @db.VarChar
  createdAt            DateTime                   @default(now()) @map("created_at")
  active               Boolean                    @default(true)
  fuelEfficiencyBase   Decimal?                   @map("fuel_efficiency_base") @db.Decimal(5, 2)
  manufacturer         String                     @db.VarChar
  typicalSeatsBusiness Int?                       @map("typical_seats_business")
  typicalSeatsEconomy  Int?                       @map("typical_seats_economy")
  typicalSeatsFirst    Int?                       @map("typical_seats_first")
  id                   String                     @id @default(uuid()) @db.Uuid
  emissionOverrides    AircraftEmissionOverride[]
  flightRecords        FlightRecord[]

  @@map("aircraft_models")
}

model ServiceClass {
  id                String                     @id @default(uuid()) @db.Uuid
  transportTypeId   String                     @map("transport_type_id") @db.Uuid
  code              String                     @unique @db.VarChar
  name              String                     @db.VarChar
  spaceMultiplier   Decimal                    @map("space_multiplier") @db.Decimal(3, 2)
  comfortFactor     Decimal                    @map("comfort_factor") @db.Decimal(3, 2)
  description       String?
  active            Boolean                    @default(true)
  createdAt         DateTime                   @default(now()) @map("created_at")
  emissionOverrides AircraftEmissionOverride[]
  emissionFactors   EmissionFactor[]
  transportType     TransportType              @relation(fields: [transportTypeId], references: [id])

  @@map("service_classes")
}

model EmissionFactor {
  id                     String                @id @default(uuid()) @db.Uuid
  transportTypeId        String                @map("transport_type_id") @db.Uuid
  haul_type              String?               @db.VarChar
  serviceClassId         String                @map("service_class_id") @db.Uuid
  factorKgCo2PerKmPerPax Decimal               @map("factor_kg_co2_per_km_per_pax") @db.Decimal(8, 5)
  source                 String                @db.VarChar
  methodology            String?               @db.VarChar
  confidenceLevel        String?               @map("confidence_level") @db.VarChar
  geographicScope        String?               @map("geographic_scope") @db.VarChar
  version                String                @db.VarChar
  validFrom              DateTime              @map("valid_from") @db.Date
  validTo                DateTime?             @map("valid_to") @db.Date
  createdAt              DateTime              @default(now()) @map("created_at")
  updatedAt              DateTime              @updatedAt @map("updated_at")
  defra_version          String?               @default("2025 Condensed") @db.VarChar(50)
  rf_included            Boolean?              @default(true)
  uncertainty_range      String?               @default("Â±10%") @db.VarChar(20)
  factorCaches           EmissionFactorCache[]
  serviceClass           ServiceClass          @relation(fields: [serviceClassId], references: [id])
  transportType          TransportType         @relation(fields: [transportTypeId], references: [id])
  flightRecords          FlightRecord[]

  @@index([transportTypeId, haul_type, serviceClassId, validFrom], map: "emission_factors_transport_type_id_aircraft_category_servic_idx")
  @@index([source, version, validFrom])
  @@map("emission_factors")
}

model AircraftEmissionOverride {
  id              String        @id @default(uuid()) @db.Uuid
  aircraftModelId String        @map("aircraft_model_id") @db.Uuid
  serviceClassId  String        @map("service_class_id") @db.Uuid
  overrideFactor  Decimal       @map("override_factor") @db.Decimal(8, 5)
  reason          String?
  source          String        @db.VarChar
  validFrom       DateTime      @map("valid_from") @db.Date
  validTo         DateTime?     @map("valid_to") @db.Date
  createdAt       DateTime      @default(now()) @map("created_at")
  aircraftModel   AircraftModel @relation(fields: [aircraftModelId], references: [id])
  serviceClass    ServiceClass  @relation(fields: [serviceClassId], references: [id])

  @@index([aircraftModelId, serviceClassId, validFrom])
  @@map("aircraft_emission_overrides")
}

model EmissionFactorCache {
  id               String         @id @default(uuid()) @db.Uuid
  cacheKey         String         @unique @map("cache_key") @db.VarChar
  transportType    String         @map("transport_type") @db.VarChar
  aircraftCategory String?        @map("aircraft_category") @db.VarChar
  serviceClass     String         @map("service_class") @db.VarChar
  finalFactor      Decimal        @map("final_factor") @db.Decimal(8, 5)
  sourceFactorId   String         @map("source_factor_id") @db.Uuid
  calculatedAt     DateTime       @map("calculated_at")
  expiresAt        DateTime       @map("expires_at")
  sourceFactor     EmissionFactor @relation(fields: [sourceFactorId], references: [id])

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("emission_factor_cache")
}

model RouteDistanceCache {
  originIata           String                     @map("origin_iata") @db.VarChar
  destinationIata      String                     @map("destination_iata") @db.VarChar
  distanceKm           Decimal                    @map("distance_km") @db.Decimal(10, 2)
  sourceApi            String                     @map("source_api") @db.VarChar
  confidenceScore      Decimal                    @map("confidence_score") @db.Decimal(3, 2)
  lastUpdated          DateTime                   @map("last_updated")
  cacheHits            Int                        @default(0) @map("cache_hits")
  createdAt            DateTime                   @default(now()) @map("created_at")
  id                   String                     @id @default(uuid()) @db.Uuid
  originAirportId      String                     @map("origin_airport_id") @db.Uuid
  destinationAirportId String                     @map("destination_airport_id") @db.Uuid
  emissionCaches       EmissionCalculationCache[]
  destinationAirport   Airport                    @relation("DestinationCache", fields: [destinationAirportId], references: [id])
  originAirport        Airport                    @relation("OriginCache", fields: [originAirportId], references: [id])

  @@unique([originIata, destinationIata])
  @@map("route_distance_cache")
}

model AnomalyRule {
  code        String   @unique @db.VarChar
  description String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  id          String   @id @default(uuid()) @db.Uuid

  @@map("anomaly_rules")
}

model EmissionSummary {
  periodMonth   DateTime @map("period_month") @db.Date
  flightsCount  Int      @map("flights_count")
  passengers    Int
  distanceKm    Decimal  @map("distance_km") @db.Decimal(12, 2)
  emissionsTco2 Decimal  @map("emissions_tco2") @db.Decimal(12, 2)
  coveragePct   Decimal  @map("coverage_pct") @db.Decimal(5, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  id            String   @id @default(uuid()) @db.Uuid
  companyId     String   @map("company_id") @db.Uuid
  company       Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, periodMonth])
  @@map("emission_summaries")
}

model RouteSummary {
  periodMonth          DateTime @map("period_month") @db.Date
  flightsCount         Int      @map("flights_count")
  emissionsTco2        Decimal  @map("emissions_tco2") @db.Decimal(12, 2)
  createdAt            DateTime @default(now()) @map("created_at")
  id                   String   @id @default(uuid()) @db.Uuid
  companyId            String   @map("company_id") @db.Uuid
  originAirportId      String   @map("origin_airport_id") @db.Uuid
  destinationAirportId String   @map("destination_airport_id") @db.Uuid
  company              Company  @relation(fields: [companyId], references: [id])
  destinationAirport   Airport  @relation("DestinationRoutes", fields: [destinationAirportId], references: [id])
  originAirport        Airport  @relation("OriginRoutes", fields: [originAirportId], references: [id])

  @@unique([companyId, periodMonth, originAirportId, destinationAirportId])
  @@map("route_summaries")
}

model BatchSummary {
  metricsJson String?     @map("metrics_json")
  createdAt   DateTime    @default(now()) @map("created_at")
  id          String      @id @default(uuid()) @db.Uuid
  batchId     String      @unique @map("batch_id") @db.Uuid
  batch       UploadBatch @relation(fields: [batchId], references: [id])

  @@map("batch_summaries")
}

model PricingTier {
  code               String                   @unique @db.VarChar
  name               String                   @db.VarChar
  minTons            Decimal                  @map("min_tons") @db.Decimal(10, 2)
  maxTons            Decimal?                 @map("max_tons") @db.Decimal(10, 2)
  pricePerTon        Decimal                  @map("price_per_ton") @db.Decimal(10, 2)
  currency           String                   @db.VarChar
  active             Boolean                  @default(true)
  createdAt          DateTime                 @default(now()) @map("created_at")
  id                 String                   @id @default(uuid()) @db.Uuid
  pricingOverrides   CompanyPricingOverride[]
  compensationOrders CompensationOrder[]

  @@map("pricing_tiers")
}

model CompanyPricingOverride {
  overridePrice Decimal     @map("override_price") @db.Decimal(10, 2)
  validFrom     DateTime    @map("valid_from")
  validTo       DateTime?   @map("valid_to")
  createdAt     DateTime    @default(now()) @map("created_at")
  id            String      @id @default(uuid()) @db.Uuid
  companyId     String      @map("company_id") @db.Uuid
  pricingTierId String      @map("pricing_tier_id") @db.Uuid
  company       Company     @relation(fields: [companyId], references: [id])
  pricingTier   PricingTier @relation(fields: [pricingTierId], references: [id])

  @@map("company_pricing_overrides")
}

model ProjectPricingVersion {
  versionName             String                @map("version_name") @db.VarChar
  basePriceUsdPerTon      Decimal               @map("base_price_usd_per_ton") @db.Decimal(10, 2)
  compensaMarginPercent   Decimal               @map("compensa_margin_percent") @db.Decimal(5, 2)
  finalPriceUsdPerTon     Decimal               @map("final_price_usd_per_ton") @db.Decimal(10, 2)
  effectiveFrom           DateTime              @map("effective_from")
  effectiveTo             DateTime?             @map("effective_to")
  status                  ProjectPricingStatus
  reason                  String?
  createdAt               DateTime              @default(now()) @map("created_at")
  id                      String                @id @default(uuid()) @db.Uuid
  projectId               String                @map("project_id") @db.Uuid
  createdBy               String                @map("created_by") @db.Uuid
  certificateProjects     CertificateProject[]
  projectPricingAuditsNew ProjectPricingAudit[] @relation("NewVersion")
  projectPricingAuditsOld ProjectPricingAudit[] @relation("OldVersion")
  creator                 User                  @relation(fields: [createdBy], references: [id])
  project                 EsgProject            @relation(fields: [projectId], references: [id])

  @@map("project_pricing_versions")
}

model GlobalMarginConfig {
  defaultMarginPercent   Decimal  @map("default_margin_percent") @db.Decimal(5, 2)
  effectiveFrom          DateTime @map("effective_from")
  appliesToNewProjects   Boolean  @default(true) @map("applies_to_new_projects")
  overrideExistingCustom Boolean  @default(false) @map("override_existing_custom")
  createdAt              DateTime @default(now()) @map("created_at")
  id                     String   @id @default(uuid()) @db.Uuid
  createdBy              String   @map("created_by") @db.Uuid
  creator                User     @relation(fields: [createdBy], references: [id])

  @@map("global_margin_config")
}

model QuickCalculation {
  routeOrigin                String         @map("route_origin") @db.VarChar
  routeDestination           String         @map("route_destination") @db.VarChar
  aircraftType               String         @map("aircraft_type") @db.VarChar
  passengersTotal            Int            @map("passengers_total")
  distanceKm                 Decimal        @map("distance_km") @db.Decimal(10, 2)
  emissionSource             EmissionSource @map("emission_source")
  totalCo2Kg                 Decimal        @map("total_co2_kg") @db.Decimal(10, 2)
  confidenceLevel            Decimal        @map("confidence_level") @db.Decimal(3, 2)
  calculationDate            DateTime       @map("calculation_date")
  apiResponseTimeMs          Int?           @map("api_response_time_ms")
  createdAt                  DateTime       @default(now()) @map("created_at")
  id                         String         @id @default(uuid()) @db.Uuid
  companyId                  String         @map("company_id") @db.Uuid
  estimatedClassDistribution Json?          @map("estimated_class_distribution")
  company                    Company        @relation(fields: [companyId], references: [id])

  @@map("quick_calculations")
}

model EmissionCalculationCache {
  aircraftType    String             @map("aircraft_type") @db.VarChar
  passengersRange String             @map("passengers_range") @db.VarChar
  emissionFactor  Decimal            @map("emission_factor") @db.Decimal(8, 5)
  co2TotalKg      Decimal            @map("co2_total_kg") @db.Decimal(10, 2)
  apiSource       String             @map("api_source") @db.VarChar
  confidenceScore Decimal            @map("confidence_score") @db.Decimal(3, 2)
  lastUsed        DateTime           @map("last_used")
  useCount        Int                @default(1) @map("use_count")
  createdAt       DateTime           @default(now()) @map("created_at")
  id              String             @id @default(uuid()) @db.Uuid
  routeCacheId    String             @map("route_cache_id") @db.Uuid
  routeCache      RouteDistanceCache @relation(fields: [routeCacheId], references: [id])

  @@unique([routeCacheId, aircraftType, passengersRange])
  @@map("emission_calculation_cache")
}

model ApiConfiguration {
  providerName      String            @map("provider_name") @db.VarChar
  endpointUrl       String            @map("endpoint_url") @db.VarChar
  apiKeyReference   String            @map("api_key_reference") @db.VarChar
  rateLimitPerHour  Int               @map("rate_limit_per_hour")
  timeoutMs         Int               @default(5000) @map("timeout_ms")
  status            ApiProviderStatus
  lastHealthCheck   DateTime?         @map("last_health_check")
  successRate24h    Decimal?          @map("success_rate_24h") @db.Decimal(3, 2)
  avgResponseTimeMs Int?              @map("avg_response_time_ms")
  createdAt         DateTime          @default(now()) @map("created_at")
  id                String            @id @default(uuid()) @db.Uuid
  apiUsageLogs      ApiUsageLog[]

  @@map("api_configurations")
}

model Payment {
  provider          String        @db.VarChar
  providerPaymentId String        @unique @map("provider_payment_id") @db.VarChar
  amount            Decimal       @db.Decimal(12, 2)
  currency          String        @db.VarChar
  status            PaymentStatus
  paidAt            DateTime?     @map("paid_at")
  createdAt         DateTime      @default(now()) @map("created_at")
  id                String        @id @default(uuid()) @db.Uuid
  companyId         String?       @map("company_id") @db.Uuid
  b2cUserId         String?       @map("b2c_user_id") @db.Uuid
  invoice           Invoice?
  b2cUser           B2cUser?      @relation(fields: [b2cUserId], references: [id])
  company           Company?      @relation(fields: [companyId], references: [id])
  refunds           Refund[]

  @@map("payments")
}

model Invoice {
  folio       String   @db.VarChar
  timbre      String   @db.VarChar
  pdfUrl      String   @map("pdf_url") @db.VarChar
  totalAmount Decimal  @map("total_amount") @db.Decimal(12, 2)
  currency    String   @db.VarChar
  issuedAt    DateTime @map("issued_at")
  createdAt   DateTime @default(now()) @map("created_at")
  id          String   @id @default(uuid()) @db.Uuid
  paymentId   String   @unique @map("payment_id") @db.Uuid
  payment     Payment  @relation(fields: [paymentId], references: [id])

  @@map("invoices")
}

model Refund {
  amount      Decimal      @db.Decimal(12, 2)
  status      RefundStatus
  requestedAt DateTime     @map("requested_at")
  processedAt DateTime?    @map("processed_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  id          String       @id @default(uuid()) @db.Uuid
  paymentId   String       @map("payment_id") @db.Uuid
  payment     Payment      @relation(fields: [paymentId], references: [id])

  @@map("refunds")
}

model FxRate {
  rateDate      DateTime @map("rate_date") @db.Date
  baseCurrency  String   @map("base_currency") @db.VarChar
  quoteCurrency String   @map("quote_currency") @db.VarChar
  rate          Decimal  @db.Decimal(12, 6)
  source        String   @db.VarChar
  createdAt     DateTime @default(now()) @map("created_at")
  id            String   @id @default(uuid()) @db.Uuid

  @@unique([rateDate, baseCurrency, quoteCurrency])
  @@map("fx_rates")
}

model CompensationOrder {
  periodMonth   DateTime    @map("period_month") @db.Date
  tonsTco2      Decimal     @map("tons_tco2") @db.Decimal(10, 2)
  amount        Decimal     @db.Decimal(12, 2)
  currency      String      @db.VarChar
  status        String      @db.VarChar
  createdAt     DateTime    @default(now()) @map("created_at")
  id            String      @id @default(uuid()) @db.Uuid
  companyId     String      @map("company_id") @db.Uuid
  pricingTierId String      @map("pricing_tier_id") @db.Uuid
  company       Company     @relation(fields: [companyId], references: [id])
  pricingTier   PricingTier @relation(fields: [pricingTierId], references: [id])

  @@map("compensation_orders")
}

model CertificateRequest {
  scope                       String        @db.VarChar
  message                     String?
  language                    String        @db.VarChar
  createdAt                   DateTime      @default(now()) @map("created_at")
  id                          String        @id @default(uuid()) @db.Uuid
  companyId                   String?       @map("company_id") @db.Uuid
  calculationMethodsBreakdown Json?         @map("calculation_methods_breakdown")
  b2cUserId                   String?       @map("b2c_user_id") @db.Uuid
  b2cUser                     B2cUser?      @relation(fields: [b2cUserId], references: [id])
  company                     Company?      @relation(fields: [companyId], references: [id])
  certificates                Certificate[]

  @@map("certificate_requests")
}

model Certificate {
  periodMonth                 DateTime             @map("period_month") @db.Date
  scope                       String               @db.VarChar
  tonsCompensated             Decimal              @map("tons_compensated") @db.Decimal(10, 2)
  weightedAvgPriceUsdPerTon   Decimal              @map("weighted_avg_price_usd_per_ton") @db.Decimal(10, 2)
  totalAmountUsd              Decimal              @map("total_amount_usd") @db.Decimal(12, 2)
  totalAmountClp              Decimal              @map("total_amount_clp") @db.Decimal(12, 2)
  number                      String               @unique @db.VarChar
  pdfUrl                      String?              @map("pdf_url") @db.VarChar
  qrCodeUrl                   String?              @map("qr_code_url") @db.VarChar
  status                      CertificateStatus
  issuedAt                    DateTime?            @map("issued_at")
  createdAt                   DateTime             @default(now()) @map("created_at")
  id                          String               @id @default(uuid()) @db.Uuid
  companyId                   String?              @map("company_id") @db.Uuid
  requestId                   String               @map("request_id") @db.Uuid
  calculationMethodsBreakdown Json?                @map("calculation_methods_breakdown")
  projectPricingVersionsUsed  Json?                @map("project_pricing_versions_used")
  b2cUserId                   String?              @map("b2c_user_id") @db.Uuid
  hash                        CertificateHash?
  projects                    CertificateProject[]
  b2cUser                     B2cUser?             @relation(fields: [b2cUserId], references: [id])
  company                     Company?             @relation(fields: [companyId], references: [id])
  request                     CertificateRequest   @relation(fields: [requestId], references: [id])
  shareEvents                 ShareEvent[]

  @@map("certificates")
}

model CertificateHash {
  hashValue     String      @map("hash_value") @db.VarChar
  createdAt     DateTime    @default(now()) @map("created_at")
  id            String      @id @default(uuid()) @db.Uuid
  certificateId String      @unique @map("certificate_id") @db.Uuid
  certificate   Certificate @relation(fields: [certificateId], references: [id])

  @@map("certificate_hashes")
}

model CertificateProject {
  percentage              Decimal               @db.Decimal(5, 2)
  allocationTons          Decimal               @map("allocation_tons") @db.Decimal(10, 2)
  priceUsdPerTon          Decimal               @map("price_usd_per_ton") @db.Decimal(10, 2)
  amountUsd               Decimal               @map("amount_usd") @db.Decimal(12, 2)
  projectNameSnapshot     String                @map("project_name_snapshot") @db.VarChar
  createdAt               DateTime              @default(now()) @map("created_at")
  certificateId           String                @map("certificate_id") @db.Uuid
  projectId               String                @map("project_id") @db.Uuid
  projectPricingVersionId String                @map("project_pricing_version_id") @db.Uuid
  certificate             Certificate           @relation(fields: [certificateId], references: [id])
  project                 EsgProject            @relation(fields: [projectId], references: [id])
  pricingVersion          ProjectPricingVersion @relation(fields: [projectPricingVersionId], references: [id])

  @@id([certificateId, projectId])
  @@map("certificate_projects")
}

model EsgProject {
  name                      String                  @db.VarChar
  code                      String                  @unique @db.VarChar
  projectType               String                  @map("project_type") @db.VarChar
  description               String?
  country                   String                  @db.VarChar
  region                    String?                 @db.VarChar
  status                    ProjectStatus
  providerOrganization      String                  @map("provider_organization") @db.VarChar
  certification             String?                 @db.VarChar
  currentBasePriceUsdPerTon Decimal                 @map("current_base_price_usd_per_ton") @db.Decimal(10, 2)
  transparencyUrl           String?                 @map("transparency_url") @db.VarChar
  createdAt                 DateTime                @default(now()) @map("created_at")
  updatedAt                 DateTime                @updatedAt @map("updated_at")
  id                        String                  @id @default(uuid()) @db.Uuid
  coBenefits                Json?                   @map("co_benefits")
  certificateProjects       CertificateProject[]
  documents                 ProjectDocument[]
  evidence                  ProjectEvidence[]
  metrics                   ProjectMetric[]
  partners                  ProjectPartner[]
  pricingAudits             ProjectPricingAudit[]
  pricingVersions           ProjectPricingVersion[]

  @@map("esg_projects")
}

model ProjectEvidence {
  periodMonth DateTime   @map("period_month") @db.Date
  photoUrl    String?    @map("photo_url") @db.VarChar
  metricName  String?    @map("metric_name") @db.VarChar
  metricValue Decimal?   @map("metric_value") @db.Decimal(12, 2)
  note        String?
  createdAt   DateTime   @default(now()) @map("created_at")
  id          String     @id @default(uuid()) @db.Uuid
  projectId   String     @map("project_id") @db.Uuid
  project     EsgProject @relation(fields: [projectId], references: [id])

  @@map("project_evidence")
}

model ProjectMetric {
  metricName  String     @map("metric_name") @db.VarChar
  metricValue Decimal    @map("metric_value") @db.Decimal(12, 2)
  recordedAt  DateTime   @map("recorded_at") @db.Date
  createdAt   DateTime   @default(now()) @map("created_at")
  id          String     @id @default(uuid()) @db.Uuid
  projectId   String     @map("project_id") @db.Uuid
  project     EsgProject @relation(fields: [projectId], references: [id])

  @@map("project_metrics")
}

model ProjectDocument {
  docType   String     @map("doc_type") @db.VarChar
  createdAt DateTime   @default(now()) @map("created_at")
  id        String     @id @default(uuid()) @db.Uuid
  projectId String     @map("project_id") @db.Uuid
  fileId    String     @map("file_id") @db.Uuid
  file      FileUpload @relation(fields: [fileId], references: [id])
  project   EsgProject @relation(fields: [projectId], references: [id])

  @@map("project_documents")
}

model ProjectPartner {
  organizationName String     @map("organization_name") @db.VarChar
  partnerRole      String     @map("partner_role") @db.VarChar
  createdAt        DateTime   @default(now()) @map("created_at")
  id               String     @id @default(uuid()) @db.Uuid
  projectId        String     @map("project_id") @db.Uuid
  project          EsgProject @relation(fields: [projectId], references: [id])

  @@map("project_partners")
}

model RankingSnapshot {
  periodMonth     DateTime @map("period_month") @db.Date
  compensatedTons Decimal  @map("compensated_tons") @db.Decimal(10, 2)
  coveragePct     Decimal  @map("coverage_pct") @db.Decimal(5, 2)
  score           Decimal  @db.Decimal(10, 2)
  segment         String   @db.VarChar
  rank            Int
  createdAt       DateTime @default(now()) @map("created_at")
  id              String   @id @default(uuid()) @db.Uuid
  companyId       String   @map("company_id") @db.Uuid
  company         Company  @relation(fields: [companyId], references: [id])

  @@unique([periodMonth, companyId])
  @@map("ranking_snapshots")
}

model BadgeDefinition {
  code           String         @unique @db.VarChar
  name           String         @db.VarChar
  type           BadgeType
  minThreshold   Decimal?       @map("min_threshold") @db.Decimal(10, 2)
  percentileRule String?        @map("percentile_rule") @db.VarChar
  description    String?
  createdAt      DateTime       @default(now()) @map("created_at")
  id             String         @id @default(uuid()) @db.Uuid
  iconUrl        String?        @map("icon_url") @db.VarChar
  b2cUserBadges  B2cUserBadge[]
  companyBadges  CompanyBadge[]

  @@map("badge_definitions")
}

model CompanyBadge {
  earnedAt  DateTime        @map("earned_at")
  expiresAt DateTime?       @map("expires_at")
  createdAt DateTime        @default(now()) @map("created_at")
  id        String          @id @default(uuid()) @db.Uuid
  companyId String          @map("company_id") @db.Uuid
  badgeId   String          @map("badge_id") @db.Uuid
  badge     BadgeDefinition @relation(fields: [badgeId], references: [id])
  company   Company         @relation(fields: [companyId], references: [id])

  @@unique([companyId, badgeId])
  @@map("company_badges")
}

model RankingJob {
  periodMonth DateTime  @map("period_month") @db.Date
  status      JobStatus
  startedAt   DateTime  @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  notes       String?
  createdAt   DateTime  @default(now()) @map("created_at")
  id          String    @id @default(uuid()) @db.Uuid

  @@map("ranking_jobs")
}

model ShareEvent {
  network       String       @db.VarChar
  sharedAt      DateTime     @map("shared_at")
  reach         Int?
  createdAt     DateTime     @default(now()) @map("created_at")
  id            String       @id @default(uuid()) @db.Uuid
  companyId     String?      @map("company_id") @db.Uuid
  certificateId String?      @map("certificate_id") @db.Uuid
  b2cUserId     String?      @map("b2c_user_id") @db.Uuid
  b2cUser       B2cUser?     @relation(fields: [b2cUserId], references: [id])
  certificate   Certificate? @relation(fields: [certificateId], references: [id])
  company       Company?     @relation(fields: [companyId], references: [id])

  @@map("share_events")
}

model ShareTemplate {
  code         String   @unique @db.VarChar
  title        String   @db.VarChar
  bodyTemplate String   @map("body_template")
  createdAt    DateTime @default(now()) @map("created_at")
  id           String   @id @default(uuid()) @db.Uuid

  @@map("share_templates")
}

model Widget {
  name       String   @db.VarChar
  configJson String?  @map("config_json")
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  id         String   @id @default(uuid()) @db.Uuid
  companyId  String   @map("company_id") @db.Uuid
  company    Company  @relation(fields: [companyId], references: [id])

  @@map("widgets")
}

model ApiKey {
  name       String    @db.VarChar
  keyHash    String    @map("key_hash") @db.VarChar
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")
  id         String    @id @default(uuid()) @db.Uuid
  companyId  String    @map("company_id") @db.Uuid
  company    Company   @relation(fields: [companyId], references: [id])

  @@map("api_keys")
}

model FileUpload {
  ownerType         String             @map("owner_type") @db.VarChar
  fileName          String             @map("file_name") @db.VarChar
  mimeType          String             @map("mime_type") @db.VarChar
  sizeBytes         Int                @map("size_bytes")
  storageUrl        String             @map("storage_url") @db.VarChar
  checksum          String             @db.VarChar
  createdAt         DateTime           @default(now()) @map("created_at")
  id                String             @id @default(uuid()) @db.Uuid
  ownerId           String             @map("owner_id") @db.Uuid
  companyDocuments  CompanyDocument[]
  entityAttachments EntityAttachment[]
  projectDocuments  ProjectDocument[]

  @@map("file_uploads")
}

model EntityAttachment {
  entityType String     @map("entity_type") @db.VarChar
  note       String?    @db.VarChar
  createdAt  DateTime   @default(now()) @map("created_at")
  id         String     @id @default(uuid()) @db.Uuid
  entityId   String     @map("entity_id") @db.Uuid
  fileId     String     @map("file_id") @db.Uuid
  file       FileUpload @relation(fields: [fileId], references: [id])

  @@map("entity_attachments")
}

model AuditLog {
  action      String   @db.VarChar
  entityType  String   @map("entity_type") @db.VarChar
  changesJson String?  @map("changes_json")
  createdAt   DateTime @default(now()) @map("created_at")
  id          String   @id @default(uuid()) @db.Uuid
  actorUserId String?  @map("actor_user_id") @db.Uuid
  entityId    String   @map("entity_id") @db.Uuid
  actor       User?    @relation(fields: [actorUserId], references: [id])

  @@map("audit_logs")
}

model LoginEvent {
  ip        String      @db.VarChar
  userAgent String      @map("user_agent") @db.VarChar
  result    LoginResult
  createdAt DateTime    @default(now()) @map("created_at")
  id        String      @id @default(uuid()) @db.Uuid
  userId    String?     @map("user_id") @db.Uuid
  user      User?       @relation(fields: [userId], references: [id])

  @@map("login_events")
}

model ProjectPricingAudit {
  changeReason        String?                @map("change_reason")
  affectedQuotesCount Int?                   @map("affected_quotes_count")
  changedAt           DateTime               @map("changed_at")
  id                  String                 @id @default(uuid()) @db.Uuid
  projectId           String                 @map("project_id") @db.Uuid
  oldVersionId        String?                @map("old_version_id") @db.Uuid
  newVersionId        String                 @map("new_version_id") @db.Uuid
  changedBy           String                 @map("changed_by") @db.Uuid
  oldValues           Json?                  @map("old_values")
  newValues           Json?                  @map("new_values")
  changedByUser       User                   @relation("ChangedByUser", fields: [changedBy], references: [id])
  newVersion          ProjectPricingVersion  @relation("NewVersion", fields: [newVersionId], references: [id])
  oldVersion          ProjectPricingVersion? @relation("OldVersion", fields: [oldVersionId], references: [id])
  project             EsgProject             @relation(fields: [projectId], references: [id])

  @@map("project_pricing_audit")
}

model ApiUsageLog {
  requestType           String           @map("request_type") @db.VarChar
  responseStatusCode    Int              @map("response_status_code")
  responseTimeMs        Int              @map("response_time_ms")
  responseDataSizeBytes Int              @map("response_data_size_bytes")
  costUsd               Decimal?         @map("cost_usd") @db.Decimal(10, 4)
  cacheHit              Boolean          @default(false) @map("cache_hit")
  createdAt             DateTime         @default(now()) @map("created_at")
  id                    String           @id @default(uuid()) @db.Uuid
  apiConfigurationId    String           @map("api_configuration_id") @db.Uuid
  companyId             String?          @map("company_id") @db.Uuid
  requestParams         Json?            @map("request_params")
  apiConfiguration      ApiConfiguration @relation(fields: [apiConfigurationId], references: [id])
  company               Company?         @relation(fields: [companyId], references: [id])

  @@map("api_usage_logs")
}

model CompanyCalculationMetric {
  periodMonth               DateTime @map("period_month") @db.Date
  manifestCalculationsCount Int      @default(0) @map("manifest_calculations_count")
  quickCalculationsCount    Int      @default(0) @map("quick_calculations_count")
  totalApiCalls             Int      @default(0) @map("total_api_calls")
  avgConfidenceScore        Decimal? @map("avg_confidence_score") @db.Decimal(3, 2)
  totalCo2CalculatedTons    Decimal? @map("total_co2_calculated_tons") @db.Decimal(12, 2)
  totalApiCostUsd           Decimal  @default(0) @map("total_api_cost_usd") @db.Decimal(10, 2)
  createdAt                 DateTime @default(now()) @map("created_at")
  id                        String   @id @default(uuid()) @db.Uuid
  companyId                 String   @map("company_id") @db.Uuid
  company                   Company  @relation(fields: [companyId], references: [id])

  @@unique([companyId, periodMonth])
  @@map("company_calculation_metrics")
}

model Webhook {
  url        String       @db.VarChar
  secret     String       @db.VarChar
  active     Boolean      @default(true)
  eventTypes String?      @map("event_types")
  createdAt  DateTime     @default(now()) @map("created_at")
  id         String       @id @default(uuid()) @db.Uuid
  companyId  String       @map("company_id") @db.Uuid
  logs       WebhookLog[]
  company    Company      @relation(fields: [companyId], references: [id])

  @@map("webhooks")
}

model WebhookLog {
  statusCode   Int      @map("status_code")
  requestBody  String?  @map("request_body")
  responseBody String?  @map("response_body")
  createdAt    DateTime @default(now()) @map("created_at")
  id           String   @id @default(uuid()) @db.Uuid
  webhookId    String   @map("webhook_id") @db.Uuid
  webhook      Webhook  @relation(fields: [webhookId], references: [id])

  @@map("webhook_logs")
}

model JobsQueue {
  jobType     String    @map("job_type") @db.VarChar
  payloadJson String?   @map("payload_json")
  status      JobStatus
  attempts    Int
  scheduledAt DateTime  @map("scheduled_at")
  startedAt   DateTime? @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  id          String    @id @default(uuid()) @db.Uuid

  @@map("jobs_queue")
}

model B2cUser {
  id                  String               @id @default(uuid()) @db.Uuid
  supabaseUid         String               @unique @map("supabase_uid") @db.Uuid
  email               String               @unique @db.VarChar(255)
  nombre              String?              @db.VarChar(255)
  avatarUrl           String?              @map("avatar_url") @db.VarChar(500)
  provider            AuthProvider         @default(google)
  preferredCurrency   String               @default("USD") @map("preferred_currency") @db.VarChar(3)
  preferredLanguage   String               @default("es") @map("preferred_language") @db.VarChar(5)
  newsletterOptIn     Boolean              @default(false) @map("newsletter_opt_in")
  totalEmissionsKg    Decimal              @default(0) @map("total_emissions_kg") @db.Decimal(12, 2)
  totalCompensatedKg  Decimal              @default(0) @map("total_compensated_kg") @db.Decimal(12, 2)
  totalFlights        Int                  @default(0) @map("total_flights")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  lastLoginAt         DateTime?            @map("last_login_at")
  calculations        B2cCalculation[]
  rankingSnapshots    B2cRankingSnapshot[]
  savedTrips          B2cSavedTrip[]
  badges              B2cUserBadge[]
  certificateRequests CertificateRequest[]
  certificates        Certificate[]
  payments            Payment[]
  shareEvents         ShareEvent[]

  @@map("b2c_users")
}

model B2cCalculation {
  id                 String         @id @default(uuid()) @db.Uuid
  userId             String         @map("user_id") @db.Uuid
  originAirport      String         @map("origin_airport") @db.VarChar(10)
  destinationAirport String         @map("destination_airport") @db.VarChar(10)
  serviceClass       String         @map("service_class") @db.VarChar(50)
  roundTrip          Boolean        @default(false) @map("round_trip")
  passengers         Int            @default(1)
  distanceKm         Decimal        @map("distance_km") @db.Decimal(10, 2)
  emissionsKg        Decimal        @map("emissions_kg") @db.Decimal(10, 2)
  isCompensated      Boolean        @default(false) @map("is_compensated")
  compensatedAt      DateTime?      @map("compensated_at")
  paymentId          String?        @map("payment_id") @db.Uuid
  certificateId      String?        @map("certificate_id") @db.Uuid
  calculationSource  EmissionSource @map("calculation_source")
  savedTripId        String?        @map("saved_trip_id") @db.Uuid
  createdAt          DateTime       @default(now()) @map("created_at")
  savedTrip          B2cSavedTrip?  @relation(fields: [savedTripId], references: [id])
  user               B2cUser        @relation(fields: [userId], references: [id])

  @@index([userId, isCompensated])
  @@index([userId, createdAt])
  @@map("b2c_calculations")
}

model B2cUserBadge {
  id        String          @id @default(uuid()) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  badgeId   String          @map("badge_id") @db.Uuid
  earnedAt  DateTime        @default(now()) @map("earned_at")
  expiresAt DateTime?       @map("expires_at")
  createdAt DateTime        @default(now()) @map("created_at")
  badge     BadgeDefinition @relation(fields: [badgeId], references: [id])
  user      B2cUser         @relation(fields: [userId], references: [id])

  @@unique([userId, badgeId])
  @@map("b2c_user_badges")
}

model B2cRankingSnapshot {
  id                 String   @id @default(uuid()) @db.Uuid
  userId             String   @map("user_id") @db.Uuid
  periodType         String   @map("period_type") @db.VarChar(20)
  periodValue        String   @map("period_value") @db.VarChar(20)
  rankPosition       Int      @map("rank_position")
  totalCompensatedKg Decimal  @map("total_compensated_kg") @db.Decimal(12, 2)
  totalFlights       Int      @map("total_flights")
  percentile         Decimal  @db.Decimal(5, 2)
  snapshotAt         DateTime @default(now()) @map("snapshot_at")
  user               B2cUser  @relation(fields: [userId], references: [id])

  @@unique([userId, periodType, periodValue])
  @@index([periodType, periodValue, rankPosition])
  @@map("b2c_ranking_snapshots")
}

model B2cSavedTrip {
  id               String           @id @default(uuid()) @db.Uuid
  userId           String           @map("user_id") @db.Uuid
  name             String           @db.VarChar(255)
  tripsJson        Json             @map("trips_json")
  totalEmissionsKg Decimal          @map("total_emissions_kg") @db.Decimal(10, 2)
  totalDistanceKm  Decimal          @map("total_distance_km") @db.Decimal(12, 2)
  isCompensated    Boolean          @default(false) @map("is_compensated")
  compensatedAt    DateTime?        @map("compensated_at")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  calculations     B2cCalculation[]
  user             B2cUser          @relation(fields: [userId], references: [id])

  @@index([userId, isCompensated])
  @@map("b2c_saved_trips")
}

enum CompanyStatus {
  registered
  pending_contract
  signed
  active
  suspended
}

enum BatchStatus {
  uploaded
  validating
  processing
  done
  failed
}

enum ValidationStatus {
  pending
  valid
  warning
  invalid
}

enum SeverityLevel {
  info
  warning
  error
}

enum PaymentStatus {
  pending
  paid
  failed
  refunded
}

enum RefundStatus {
  requested
  processing
  completed
  failed
}

enum CertificateStatus {
  draft
  issued
  revoked
}

enum ProjectStatus {
  planned
  active
  completed
  paused
  maintenance
}

enum BadgeType {
  permanent
  temporary
}

enum JobStatus {
  queued
  running
  succeeded
  failed
}

enum LoginResult {
  success
  failure
}

enum CalculationType {
  MANIFEST_UPLOAD
  MINIMAL_INPUT
}

enum EmissionSource {
  internal_factors
  google_travel_impact_api
  icao_calculator_api
  mixed_sources
}

enum ProjectPricingStatus {
  draft
  scheduled
  active
  superseded
}

enum ApiProviderStatus {
  active
  inactive
  maintenance
}

enum AuthProvider {
  google
  apple
  email
}
